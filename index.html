<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maliyet UygulamasÄ± (Dinamik Salata + Dinamik Paketleme)</title>
<style>
:root{
  --bg:#050a18;
  --panel:#0d1a33;
  --text:#f6f9ff;
  --muted:#c2d0ea;
  --accent:#2cf3b1;
  --warn:#ffd166;
  --danger:#ff5f82;
  --line:rgba(255,255,255,.18);
  --shadow:0 24px 60px rgba(0,0,0,.7);
  --radius:16px;
  --ring:0 0 0 3px rgba(44,243,177,.3);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
}

body{
  margin:0;
  background:radial-gradient(1200px 800px at 18% 8%, #1c4290 0%, var(--bg) 58%);
  color:var(--text);
  line-height:1.5
}

header{padding:18px 20px;position:sticky;top:0;backdrop-filter:blur(12px);background:rgba(5,9,20,.9);border-bottom:1px solid rgba(255,255,255,.2);z-index:5}
header h1{font-size:17.5px;margin:0;font-weight:750;letter-spacing:.35px}
header .sub{font-size:12.5px;color:var(--muted);margin-top:6px}
main{padding:20px;display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start}
@media (max-width:980px){main{grid-template-columns:1fr}}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.32);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden
}
.card .hd{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.24);display:flex;justify-content:space-between;align-items:center;gap:10px}
.card .hd h2{margin:0;font-size:14.5px;font-weight:800;letter-spacing:.35px}
.card .bd{padding:14px 16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1 1 140px}
label{display:block;font-size:11.5px;color:var(--muted);margin-bottom:6px;font-weight:650;letter-spacing:.25px}
input, select, button{
  width:100%;
  box-sizing:border-box;
  background:rgba(4,8,18,.78);
  border:1px solid rgba(255,255,255,.3);
  border-radius:12px;
  color:var(--text);
  padding:10px 12px;
  outline:none;
  transition:border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .2s ease
}
input:focus,select:focus{border-color:rgba(44,243,177,.8);box-shadow:var(--ring);background:rgba(7,12,24,.9)}
input:hover,select:hover{border-color:rgba(255,255,255,.4)}
button{cursor:pointer;font-weight:700;background:rgba(44,243,177,.32);border-color:rgba(44,243,177,.6);box-shadow:0 14px 24px rgba(0,0,0,.45)}
button:hover{background:rgba(44,243,177,.45);transform:translateY(-1px)}
button:focus{box-shadow:var(--ring)}
.btn2{background:rgba(255,209,102,.22);border-color:rgba(255,209,102,.55)}
.btn2:hover{background:rgba(255,209,102,.36)}
.btndanger{background:rgba(255,95,130,.22);border-color:rgba(255,95,130,.55)}
.btndanger:hover{background:rgba(255,95,130,.36)}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media (max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}}
.k{
  background:rgba(6,12,24,.78);
  border:1px solid rgba(255,255,255,.28);
  border-radius:14px;
  padding:12px
}
.k .t{font-size:10.5px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
.k .v{margin-top:8px;font-size:20px;font-weight:800}
.k .v.warn{color:var(--warn)}
.k .v.acc{color:var(--accent)}
.k .v.dng{color:var(--danger)}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:9px 8px;border-bottom:1px solid rgba(255,255,255,.2);text-align:left}
th{
  color:#e1edff;
  font-weight:800;
  font-size:10.5px;
  text-transform:uppercase;
  letter-spacing:.08em;
  background:rgba(3,8,18,.92)
}
th:first-child,
th:nth-child(2){
  color:var(--warn);
}
th.section{background:rgba(5,12,26,.98);color:var(--accent);font-size:10px}
tbody tr:nth-child(even) td{background:rgba(255,255,255,.015)}
tr:hover td{background:rgba(255,255,255,.1)}
.mini{font-size:11.5px;color:var(--muted);margin-top:8px;line-height:1.45}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.24);border-radius:999px;background:rgba(5,10,20,.7);font-size:11px;color:var(--muted)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:980px){.grid2{grid-template-columns:1fr}}
.tight input{padding:8px 10px;border-radius:10px}
.right{text-align:right}
.muted{color:var(--muted)}
.ok{color:var(--accent)}
.warn{color:var(--warn)}
.dng{color:var(--danger)}
</style>
</head>
<body>
<header>
  <h1>Maliyet UygulamasÄ± â€” Dinamik Salata + Dinamik Paketleme</h1>
  <div class="sub">Sabit 20/29 gibi deÄŸerler yok. Her ÅŸey reÃ§ete + birim fiyatlarla hesaplanÄ±r. (Offline Ã§alÄ±ÅŸÄ±r, Kaydet/YÃ¼kle ile hafÄ±zaya alÄ±r)</div>
</header>

<main>
  <section class="card">
    <div class="hd"><h2>Ayarlar</h2><span class="pill" id="statePill">Durum: hazÄ±r</span></div>
    <div class="bd">
      <div class="row">
        <div class="col"><label>Komisyon % (c)</label><input id="c" type="number" step="0.1" value="10"></div>
        <div class="col"><label>SatÄ±ÅŸ KDV % (v)</label><input id="v" type="number" step="0.1" value="10"></div>
        <div class="col"><label>Komisyon KDV %</label><input id="cv" type="number" step="0.1" value="18"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col"><label>Net gelir katsayÄ±sÄ±</label><input id="katsayi" type="number" step="0.001" value="0.791"></div>
        <div class="col" style="display:flex; align-items:end;"><button id="calcK">KatsayÄ±yÄ± hesapla</button></div>
      </div>

      <div class="mini">KatsayÄ± mantÄ±ÄŸÄ±: <span class="muted">Etiket (KDV dahil)</span> Ã— <span class="ok">katsayÄ±</span> = <span class="muted">Net gelir</span> (platform kesintileri + KDV sonrasÄ±).<br/>Not: Senin tablondaki doÄŸrulanmÄ±ÅŸ deÄŸer: <b>0,791</b>.</div>

      <hr style="border:0;border-top:1px solid var(--line); margin:14px 0;"/>

      <div class="row">
        <div class="col"><label>Hedef Net KÃ¢r (Porsiyon / 500 g)</label><input id="targetSmall" type="number" step="1" value="135"></div>
        <div class="col"><label>Hedef Net KÃ¢r (1 kg)</label><input id="targetKg" type="number" step="1" value="220"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col"><button id="saveBtn">Kaydet</button></div>
        <div class="col"><button class="btn2" id="loadBtn">YÃ¼kle</button></div>
        <div class="col"><button class="btndanger" id="resetBtn">Verileri SÄ±fÄ±rla</button></div>
      </div>

      <div class="mini">Kaydet/YÃ¼kle tarayÄ±cÄ± hafÄ±zasÄ±na (localStorage) yazar/okur.</div>
    </div>
  </section>

  <section style="display:grid; gap:14px;">
    <section class="card">
      <div class="hd"><h2>HÄ±zlÄ± Hesap</h2><div class="pill">SeÃ§ â†’ maliyetleri gÃ¶r â†’ etiket fiyatÄ±nÄ± Ã¼ret</div></div>
      <div class="bd">
        <div class="row">
          <div class="col"><label>ÃœrÃ¼n</label><select id="urunSel"></select></div>
          <div class="col"><label>Boy</label><select id="boySel"></select></div>
          <div class="col"><label>Adet</label><input id="adetSel" type="number" step="1" value="1" min="1"></div>
          <div class="col"><label>Ekstra Ayran (adet)</label><input id="ayranSel" type="number" step="1" value="0" min="0"></div>
          <div class="col"><label>Ekmek (adet)</label><input id="ekmekSel" type="number" step="1" value="1" min="0"></div>
        </div>

        <div class="kpi" style="margin-top:12px;">
          <div class="k"><div class="t">Et Maliyeti</div><div class="v" id="kEt">-</div></div>
          <div class="k"><div class="t">Salata Maliyeti</div><div class="v" id="kSalata">-</div></div>
          <div class="k"><div class="t">Paketleme Maliyeti</div><div class="v" id="kPack">-</div></div>
          <div class="k"><div class="t">Toplam Maliyet</div><div class="v warn" id="kTop">-</div></div>
        </div>

        <div class="kpi" style="margin-top:10px;">
          <div class="k"><div class="t">Hedef Net KÃ¢r</div><div class="v acc" id="kHedef">-</div></div>
          <div class="k"><div class="t">Ã–nerilen Etiket (KDV dahil)</div><div class="v acc" id="kEtiket">-</div></div>
          <div class="k"><div class="t">Net Gelir (EtiketÃ—katsayÄ±)</div><div class="v" id="kNetGelir">-</div></div>
          <div class="k"><div class="t">Net KÃ¢r</div><div class="v" id="kNetKar">-</div></div>
        </div>

        <div class="mini">Net kÃ¢r hesabÄ±: <b>Net gelir = Etiket Ã— katsayÄ±</b> â†’ <b>Net kÃ¢r = Net gelir - Toplam maliyet</b>.</div>
      </div>
    </section>

    <section class="grid2">
      <section class="card">
        <div class="hd"><h2>Birim Fiyatlar</h2><span class="pill">kg ve adet</span></div>
        <div class="bd tight">
          <table id="tblPrices"></table>
          <div class="mini">Birim fiyat deÄŸiÅŸtirince tÃ¼m hesaplar anÄ±nda gÃ¼ncellenir.</div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>Paketleme ReÃ§etesi (adet)</h2><span class="pill">Boy bazlÄ±</span></div>
        <div class="bd tight">
          <table id="tblPack"></table>
          <div class="row" style="margin-top:10px;">
            <div class="col"><button id="addPackExtra">+ Kalem ekle</button></div>
          </div>
          <div class="mini">Porsiyon/500g ve 1kg iÃ§in paketleme adetlerini dÃ¼zenleyebilirsin.</div>
        </div>
      </section>
    </section>

    <section class="card">
      <div class="hd"><h2>ÃœrÃ¼n ReÃ§eteleri (gram)</h2><span class="pill">Et + Salata</span></div>
      <div class="bd tight">
        <div class="mini" style="margin-bottom:8px;">Her satÄ±r bir Ã¼rÃ¼n+boy kombinasyonu. Gram deÄŸiÅŸtirince maliyet otomatik gÃ¼ncellenir.</div>
        <div style="max-height:360px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
          <table id="tblRec"></table>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd"><h2>TÃ¼m Kombinasyonlar (Ã–zet)</h2><div class="row" style="gap:8px; align-items:center;"><button id="refreshAll">Ã–zeti Yenile</button></div></div>
      <div class="bd">
        <div style="max-height:360px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
          <table id="tblAll"></table>
        </div>
        <div class="mini">Bu tabloda adet=1, ayran=0, ekmek=1 varsayÄ±mÄ±yla listeler.</div>
      </div>
    </section>
  </section>
</main>

<script>
const DEFAULT = {
  params:{c:10,v:10,cv:18,katsayi:0.791,targetSmall:135,targetKg:220},
  prices:{
    "Bonfile":{unit:"kg",price:138},
    "Pirzola":{unit:"kg",price:100},
    "Kanat":{unit:"kg",price:150},
    "KÃ¶fte":{unit:"kg",price:300},
    "Marul":{unit:"kg",price:85},
    "Domates":{unit:"kg",price:59},
    "SoÄŸan":{unit:"kg",price:15},
    "LavaÅŸ":{unit:"adet",price:2},
    "Pilav paketi (120 g)":{unit:"adet",price:2},
    "SÄ±zdÄ±rmaz kap":{unit:"adet",price:1.35},
    "KÃ¶pÃ¼k tabak":{unit:"adet",price:1.25},
    "6'lÄ± servis set":{unit:"adet",price:1.5},
    "PoÅŸet":{unit:"adet",price:0.5},
    "Ayran":{unit:"adet",price:20},
    "Ekmek":{unit:"adet",price:6}
  },
  packBySize:{
    "Porsiyon":{"LavaÅŸ":0.5,"Pilav paketi (120 g)":1,"SÄ±zdÄ±rmaz kap":1,"KÃ¶pÃ¼k tabak":2,"6'lÄ± servis set":1,"PoÅŸet":1},
    "500 g":{"LavaÅŸ":0.5,"Pilav paketi (120 g)":1,"SÄ±zdÄ±rmaz kap":1,"KÃ¶pÃ¼k tabak":2,"6'lÄ± servis set":1,"PoÅŸet":1},
    "1 kg":{"LavaÅŸ":1,"Pilav paketi (120 g)":2,"SÄ±zdÄ±rmaz kap":2,"KÃ¶pÃ¼k tabak":2,"6'lÄ± servis set":1,"PoÅŸet":1}
  },
  packExtras:[],
  recipes:[
    {urun:"KarÄ±ÅŸÄ±k",boy:"Porsiyon",Bonfile:70,Pirzola:130,Kanat:80,"KÃ¶fte":70,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"Bonfile",boy:"Porsiyon",Bonfile:300,Pirzola:0,Kanat:0,"KÃ¶fte":0,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"Pirzola",boy:"Porsiyon",Bonfile:0,Pirzola:300,Kanat:0,"KÃ¶fte":0,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"Kanat",boy:"Porsiyon",Bonfile:0,Pirzola:0,Kanat:300,"KÃ¶fte":0,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"KÃ¶fte",boy:"Porsiyon",Bonfile:0,Pirzola:0,Kanat:0,"KÃ¶fte":210,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},

    {urun:"KarÄ±ÅŸÄ±k",boy:"500 g",Bonfile:100,Pirzola:186,Kanat:114,"KÃ¶fte":100,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"Bonfile",boy:"500 g",Bonfile:500,Pirzola:0,Kanat:0,"KÃ¶fte":0,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"Pirzola",boy:"500 g",Bonfile:0,Pirzola:500,Kanat:0,"KÃ¶fte":0,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"Kanat",boy:"500 g",Bonfile:0,Pirzola:0,Kanat:500,"KÃ¶fte":0,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},
    {urun:"KÃ¶fte",boy:"500 g",Bonfile:0,Pirzola:0,Kanat:0,"KÃ¶fte":500,Marul:30,Domates:30,"SoÄŸan":30,Ekmek:0,Ayran:0},

    {urun:"KarÄ±ÅŸÄ±k",boy:"1 kg",Bonfile:200,Pirzola:371,Kanat:229,"KÃ¶fte":200,Marul:60,Domates:60,"SoÄŸan":60,Ekmek:0,Ayran:0},
    {urun:"Bonfile",boy:"1 kg",Bonfile:1000,Pirzola:0,Kanat:0,"KÃ¶fte":0,Marul:60,Domates:60,"SoÄŸan":60,Ekmek:0,Ayran:0},
    {urun:"Pirzola",boy:"1 kg",Bonfile:0,Pirzola:1000,Kanat:0,"KÃ¶fte":0,Marul:60,Domates:60,"SoÄŸan":60,Ekmek:0,Ayran:0},
    {urun:"Kanat",boy:"1 kg",Bonfile:0,Pirzola:0,Kanat:1000,"KÃ¶fte":0,Marul:60,Domates:60,"SoÄŸan":60,Ekmek:0,Ayran:0},
    {urun:"KÃ¶fte",boy:"1 kg",Bonfile:0,Pirzola:0,Kanat:0,"KÃ¶fte":1000,Marul:60,Domates:60,"SoÄŸan":60,Ekmek:0,Ayran:0}
  ]
};
const LS_KEY="maliyet_app_v2_dynamic_pack";
const FIELD_LS_KEY="maliyet_app_field_state_v1";
const safeClone = typeof structuredClone === "function"
  ? structuredClone
  : (obj) => JSON.parse(JSON.stringify(obj));
let STATE=safeClone(DEFAULT);
let FIELD_STATE={};
const TRACKED_FIELDS=new WeakSet();

const fmt=n=>isFinite(n)?new Intl.NumberFormat("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n)+" TL":"-";
const fmt0=n=>isFinite(n)?new Intl.NumberFormat("tr-TR",{maximumFractionDigits:0}).format(n)+" TL":"-";
const num=v=>{const x=parseFloat(String(v).replace(",", "."));return isFinite(x)?x:0};

function setPill(text,kind="ok"){
  const el=document.getElementById("statePill");
  el.textContent=text;
  el.style.borderColor=kind==="dng"?"rgba(251,113,133,.5)":kind==="warn"?"rgba(251,191,36,.5)":"rgba(52,211,153,.45)";
  el.style.color=kind==="dng"?"var(--danger)":kind==="warn"?"var(--warn)":"var(--muted)";
}

function computeKatsayi(cPct,vPct,cvPct){
  const c=cPct/100,v=vPct/100,cv=cvPct/100;
  const k=(1-v)*(1-c*(1+cv)); // yaklaÅŸÄ±k
  return Math.max(0,Math.min(1,k));
}

function getRecipe(urun,boy){return STATE.recipes.find(r=>r.urun===urun&&r.boy===boy)}
function costMeat(r){
  const p=STATE.prices;
  return (r.Bonfile/1000)*p["Bonfile"].price+(r.Pirzola/1000)*p["Pirzola"].price+(r.Kanat/1000)*p["Kanat"].price+(r["KÃ¶fte"]/1000)*p["KÃ¶fte"].price;
}
function costSalad(r){
  const p=STATE.prices;
  return (r.Marul/1000)*p["Marul"].price+(r.Domates/1000)*p["Domates"].price+(r["SoÄŸan"]/1000)*p["SoÄŸan"].price;
}
function costPack(boy,adet=1,ayran=0,ekmek=0){
  const p=STATE.prices, pack=STATE.packBySize[boy];
  let s=0;
  for(const k of Object.keys(pack)) s+=(pack[k]||0)*(p[k]?.price??0);
  for(const extra of STATE.packExtras){
    if(!extra) continue;
    const qty=extra.qty||0;
    const price=p[extra.item]?.price??0;
    s+=qty*price;
  }
  s+=(ayran||0)*p["Ayran"].price;
  s+=(ekmek||0)*p["Ekmek"].price;
  return s*adet;
}
function totalCost(urun,boy,adet=1,ayran=0,ekmek=0){
  const r=getRecipe(urun,boy); if(!r) return {et:0,salata:0,pack:0,total:0};
  const p=STATE.prices;
  const extraPerItem=(r.Ekmek||0)*(p["Ekmek"]?.price??0)+(r.Ayran||0)*(p["Ayran"]?.price??0);
  const et=costMeat(r)*adet, salata=costSalad(r)*adet, pack=costPack(boy,adet,ayran,ekmek)+(extraPerItem*adet);
  return {et,salata,pack,total:et+salata+pack};
}
function targetForSize(boy){return boy==="1 kg"?num(document.getElementById("targetKg").value):num(document.getElementById("targetSmall").value)}
function recommendedLabelPrice(maliyet,hedef,k){return k>0?(maliyet+hedef)/k:NaN}

function renderSelectors(){
  const urunSel=document.getElementById("urunSel"), boySel=document.getElementById("boySel");
  const urunler=[...new Set(STATE.recipes.map(r=>r.urun))];
  urunSel.innerHTML=urunler.map(u=>`<option value="${u}">${u}</option>`).join("");
  const fillBoy=()=>{const boys=STATE.recipes.filter(r=>r.urun===urunSel.value).map(r=>r.boy); boySel.innerHTML=boys.map(b=>`<option value="${b}">${b}</option>`).join("")}
  urunSel.addEventListener("change",()=>{fillBoy();refreshQuick()});
  boySel.addEventListener("change",refreshQuick);
  fillBoy();
}
function renderPrices(){
  const tbl=document.getElementById("tblPrices");
  const rows=Object.entries(STATE.prices);
  tbl.innerHTML=`<thead><tr><th>Kalem</th><th>Birim</th><th class="right">Birim Fiyat (TL)</th></tr></thead>
  <tbody>${rows.map(([k,v])=>`<tr><td>${k}</td><td class="muted">${v.unit}</td><td class="right"><input data-price="${k}" type="number" step="0.01" value="${v.price}"></td></tr>`).join("")}</tbody>`;
  tbl.querySelectorAll("input[data-price]").forEach(inp=>{
    inp.addEventListener("input",e=>{const key=e.target.getAttribute("data-price"); STATE.prices[key].price=num(e.target.value); renderPack(); refreshQuick();});
  });
}
function renderPack(){
  const tbl=document.getElementById("tblPack");
  const items=Object.keys(STATE.packBySize["Porsiyon"]);
  const sizes=Object.keys(STATE.packBySize);
  tbl.innerHTML=`<thead><tr><th>Kalem</th>${sizes.map(s=>`<th class="right">${s}</th>`).join("")}</tr></thead>
  <tbody>${items.map(it=>`<tr><td>${it}</td>${sizes.map(s=>`<td class="right"><input data-pack="${it}" data-size="${s}" type="number" step="0.1" value="${STATE.packBySize[s][it]??0}"></td>`).join("")}</tr>`).join("")}
    <tr><th class="section" colspan="${sizes.length + 1}">Ek Paketleme Kalemleri</th></tr>
    ${STATE.packExtras.map((row,idx)=>{
      const item=row?.item||"";
      const qty=row?.qty??0;
      const price=STATE.prices[item]?.price??0;
      const cost=qty*price;
      return `<tr>
        <td>
          <select data-pack-extra-item="${idx}">
            <option value="">Kalem seÃ§</option>
            ${Object.keys(STATE.prices).map(key=>`<option value="${key}" ${key===item?"selected":""}>${key}</option>`).join("")}
          </select>
        </td>
        <td class="right"><input data-pack-extra-qty="${idx}" type="number" step="1" min="0" value="${qty}"></td>
        <td class="right">${fmt(cost)}</td>
        <td class="right"><button class="btndanger" data-pack-extra-remove="${idx}">Sil</button></td>
      </tr>`;
    }).join("")}
  </tbody>`;
  tbl.querySelectorAll("input[data-pack]").forEach(inp=>{
    inp.addEventListener("input",e=>{const it=e.target.getAttribute("data-pack"); const s=e.target.getAttribute("data-size"); STATE.packBySize[s][it]=num(e.target.value); refreshQuick();});
  });
  tbl.querySelectorAll("select[data-pack-extra-item]").forEach(sel=>{
    sel.addEventListener("change",e=>{
      const idx=parseInt(e.target.getAttribute("data-pack-extra-item"),10);
      STATE.packExtras[idx].item=e.target.value;
      renderPack();refreshQuick();
    });
  });
  tbl.querySelectorAll("input[data-pack-extra-qty]").forEach(inp=>{
    inp.addEventListener("input",e=>{
      const idx=parseInt(e.target.getAttribute("data-pack-extra-qty"),10);
      STATE.packExtras[idx].qty=Math.max(0,Math.round(num(e.target.value)));
      renderPack();refreshQuick();
    });
  });
  tbl.querySelectorAll("button[data-pack-extra-remove]").forEach(btn=>{
    btn.addEventListener("click",e=>{
      const idx=parseInt(e.target.getAttribute("data-pack-extra-remove"),10);
      STATE.packExtras.splice(idx,1);
      renderPack();refreshQuick();
      scheduleStateSave();
    });
  });
}
function renderRecipes(){
  const tbl=document.getElementById("tblRec");
  const cols=["Bonfile","Pirzola","Kanat","KÃ¶fte","Marul","Domates","SoÄŸan"];
  const extras=["Ekmek","Ayran"];
  tbl.innerHTML=`<thead>
    <tr>
      <th rowspan="2">ÃœrÃ¼n</th>
      <th rowspan="2">Boy</th>
      <th class="section" colspan="${cols.length}">Et + Salata</th>
      <th class="section" colspan="${extras.length}">Ekstralar</th>
    </tr>
    <tr>
      ${cols.map(c=>`<th class="right">${c} (g)</th>`).join("")}
      ${extras.map(c=>`<th class="right">${c} (adet)</th>`).join("")}
    </tr>
  </thead>
  <tbody>${STATE.recipes.map((r,idx)=>`<tr><td>${r.urun}</td><td class="muted">${r.boy}</td>${cols.map(c=>`<td class="right"><input data-rec="${idx}" data-col="${c}" type="number" step="1" value="${r[c]}"></td>`).join("")}${extras.map(c=>`<td class="right"><input data-rec="${idx}" data-col="${c}" type="number" step="1" min="0" value="${r[c]??0}"></td>`).join("")}</tr>`).join("")}</tbody>`;
  tbl.querySelectorAll("input[data-rec]").forEach(inp=>{
    inp.addEventListener("input",e=>{const idx=parseInt(e.target.getAttribute("data-rec"),10); const col=e.target.getAttribute("data-col"); STATE.recipes[idx][col]=Math.max(0,Math.round(num(e.target.value))); refreshQuick();});
  });
}
function renderAll(){
  const tbl=document.getElementById("tblAll");
  const k=num(document.getElementById("katsayi").value);
  const rows=STATE.recipes.map(r=>{
    const costs=totalCost(r.urun,r.boy,1,0,1);
    const hedef=targetForSize(r.boy);
    const etiket=recommendedLabelPrice(costs.total,hedef,k);
    const netKar=(etiket*k)-costs.total;
    return {...r,costs,hedef,etiket,netKar};
  });
  tbl.innerHTML=`<thead><tr><th>ÃœrÃ¼n</th><th>Boy</th><th class="right">Et</th><th class="right">Salata</th><th class="right">Paket</th><th class="right">Toplam</th><th class="right">Hedef</th><th class="right">Etiket</th><th class="right">Net KÃ¢r</th></tr></thead>
  <tbody>${rows.map(x=>`<tr><td>${x.urun}</td><td class="muted">${x.boy}</td><td class="right">${fmt0(x.costs.et)}</td><td class="right">${fmt0(x.costs.salata)}</td><td class="right">${fmt0(x.costs.pack)}</td><td class="right"><b>${fmt0(x.costs.total)}</b></td><td class="right">${fmt0(x.hedef)}</td><td class="right"><b class="ok">${fmt0(x.etiket)}</b></td><td class="right">${fmt0(x.netKar)}</td></tr>`).join("")}</tbody>`;
}

function refreshQuick(){
  const urun=document.getElementById("urunSel").value;
  const boy=document.getElementById("boySel").value;
  const adet=Math.max(1,Math.round(num(document.getElementById("adetSel").value)));
  const ayran=Math.max(0,Math.round(num(document.getElementById("ayranSel").value)));
  const ekmek=Math.max(0,Math.round(num(document.getElementById("ekmekSel").value)));
  document.getElementById("adetSel").value=adet;
  const k=num(document.getElementById("katsayi").value);
  const hedef=targetForSize(boy)*adet;
  const costs=totalCost(urun,boy,adet,ayran,ekmek);
  const etiket=recommendedLabelPrice(costs.total,hedef,k);
  const netGelir=etiket*k;
  const netKar=netGelir-costs.total;

  document.getElementById("kEt").textContent=fmt(costs.et);
  document.getElementById("kSalata").textContent=fmt(costs.salata);
  document.getElementById("kPack").textContent=fmt(costs.pack);
  document.getElementById("kTop").textContent=fmt(costs.total);

  document.getElementById("kHedef").textContent=fmt(hedef);
  document.getElementById("kEtiket").textContent=fmt(etiket);
  document.getElementById("kNetGelir").textContent=fmt(netGelir);

  const nk=document.getElementById("kNetKar");
  nk.textContent=fmt(netKar);
  nk.className="v "+(netKar>=hedef*0.98?"acc":(netKar>=0?"warn":"dng"));
}

function syncParamsFromUI(){
  STATE.params.c=num(document.getElementById("c").value);
  STATE.params.v=num(document.getElementById("v").value);
  STATE.params.cv=num(document.getElementById("cv").value);
  STATE.params.katsayi=num(document.getElementById("katsayi").value);
  STATE.params.targetSmall=num(document.getElementById("targetSmall").value);
  STATE.params.targetKg=num(document.getElementById("targetKg").value);
}
function pushParamsToUI(){
  document.getElementById("c").value=STATE.params.c;
  document.getElementById("v").value=STATE.params.v;
  document.getElementById("cv").value=STATE.params.cv;
  document.getElementById("katsayi").value=STATE.params.katsayi;
  document.getElementById("targetSmall").value=STATE.params.targetSmall;
  document.getElementById("targetKg").value=STATE.params.targetKg;
}
let STATE_SAVE_TIMER=null;
function saveStateSilently(){
  syncParamsFromUI();
  localStorage.setItem(LS_KEY, JSON.stringify(STATE));
}
function scheduleStateSave(){
  clearTimeout(STATE_SAVE_TIMER);
  STATE_SAVE_TIMER=setTimeout(saveStateSilently,150);
}
function save(){
  saveStateSilently();
  setPill("Durum: kaydedildi âœ…","ok");
}
function load(){
  const raw=localStorage.getItem(LS_KEY);
  if(!raw){setPill("Durum: kayÄ±t yok","warn");return;}
  try{
    STATE=JSON.parse(raw);
    STATE.params=Object.assign({},DEFAULT.params,STATE.params||{});
    STATE.prices=Object.assign({},DEFAULT.prices,STATE.prices||{});
    STATE.packBySize=Object.assign({},DEFAULT.packBySize,STATE.packBySize||{});
    STATE.packExtras=Array.isArray(STATE.packExtras)
      ? STATE.packExtras.map(r=>({item:r?.item||"",qty:Math.max(0,Math.round(num(r?.qty)))}))
      : safeClone(DEFAULT.packExtras);
    STATE.recipes=Array.isArray(STATE.recipes)
      ? STATE.recipes.map(r=>({...r,Ekmek:r.Ekmek??0,Ayran:r.Ayran??0}))
      : safeClone(DEFAULT.recipes);
    pushParamsToUI();
    renderAllUI();
    setPill("Durum: yÃ¼klendi âœ…","ok");
    storeAllFields();
  }catch(e){console.error(e);setPill("Durum: yÃ¼kleme hatasÄ±","dng");}
}
function resetAll(){
  STATE=safeClone(DEFAULT);
  pushParamsToUI();
  renderAllUI();
  setPill("Durum: sÄ±fÄ±rlandÄ±","warn");
  storeAllFields();
}

function getAllFields(root=document){
  return Array.from(root.querySelectorAll("input, select, textarea"));
}
function isTrackableField(el){
  if(!el || el.disabled) return false;
  if(el.tagName.toLowerCase()==="input"){
    const type=(el.getAttribute("type")||"").toLowerCase();
    if(["button","submit","reset","hidden","file"].includes(type)) return false;
  }
  return true;
}
function getDomPath(el){
  const parts=[];
  let node=el;
  while(node && node.nodeType===1 && node!==document.body && node!==document.documentElement){
    let part=node.tagName.toLowerCase();
    if(node.id){
      part+=`#${node.id}`;
    }else{
      const parent=node.parentElement;
      if(parent){
        const siblings=[...parent.children].filter(child=>child.tagName===node.tagName);
        const index=siblings.indexOf(node)+1;
        part+=`:nth-of-type(${index})`;
      }
    }
    parts.unshift(part);
    node=node.parentElement;
  }
  return parts.join(">");
}
function getFieldBaseKey(el){
  return el.dataset.key||el.getAttribute("name")||el.id||getDomPath(el);
}
function getFieldKey(el){
  const base=getFieldBaseKey(el);
  const path=getDomPath(el);
  return base===path?base:`${base}::${path}`;
}
function getFieldValue(el){
  if(el.type==="checkbox"||el.type==="radio") return el.checked;
  return el.value;
}
function setFieldValue(el,value){
  if(el.type==="checkbox"||el.type==="radio"){
    el.checked=Boolean(value);
  }else if(value!==undefined && value!==null){
    el.value=value;
  }
}
function loadFieldState(){
  try{
    FIELD_STATE=JSON.parse(localStorage.getItem(FIELD_LS_KEY)||"{}")||{};
  }catch(e){
    console.error(e);
    FIELD_STATE={};
  }
}
function persistFieldState(){
  localStorage.setItem(FIELD_LS_KEY, JSON.stringify(FIELD_STATE));
}
function updateFieldState(el){
  if(!isTrackableField(el)) return;
  const key=getFieldKey(el);
  FIELD_STATE[key]=getFieldValue(el);
  persistFieldState();
  scheduleStateSave();
}
function registerField(el){
  if(!isTrackableField(el) || TRACKED_FIELDS.has(el)) return;
  TRACKED_FIELDS.add(el);
  const isChoice=el.type==="checkbox"||el.type==="radio"||el.tagName.toLowerCase()==="select";
  const eventName=isChoice?"change":"input";
  el.addEventListener(eventName,()=>updateFieldState(el));
  if(eventName==="change" && el.tagName.toLowerCase()!=="select"){
    el.addEventListener("input",()=>updateFieldState(el));
  }
}
function applyStoredValues(root=document){
  getAllFields(root).forEach(el=>{
    if(!isTrackableField(el)) return;
    const key=getFieldKey(el);
    if(Object.prototype.hasOwnProperty.call(FIELD_STATE,key)){
      const prev=getFieldValue(el);
      setFieldValue(el, FIELD_STATE[key]);
      if(getFieldValue(el)!==prev){
        const isChoice=el.type==="checkbox"||el.type==="radio"||el.tagName.toLowerCase()==="select";
        const eventName=isChoice?"change":"input";
        el.dispatchEvent(new Event(eventName,{bubbles:true}));
      }
    }
    registerField(el);
  });
}
function storeAllFields(){
  getAllFields().forEach(el=>{
    if(!isTrackableField(el)) return;
    FIELD_STATE[getFieldKey(el)]=getFieldValue(el);
  });
  persistFieldState();
}
function initFieldPersistence(){
  loadFieldState();
  applyStoredValues();
  const observer=new MutationObserver(mutations=>{
    const added=[];
    mutations.forEach(mutation=>{
      mutation.addedNodes.forEach(node=>{
        if(node.nodeType!==1) return;
        if(node.matches && node.matches("input, select, textarea")) added.push(node);
        if(node.querySelectorAll) added.push(...node.querySelectorAll("input, select, textarea"));
      });
    });
    if(added.length){
      added.forEach(el=>{
        if(!isTrackableField(el)) return;
        registerField(el);
        const key=getFieldKey(el);
        if(Object.prototype.hasOwnProperty.call(FIELD_STATE,key)){
          const prev=getFieldValue(el);
          setFieldValue(el, FIELD_STATE[key]);
          if(getFieldValue(el)!==prev){
            const isChoice=el.type==="checkbox"||el.type==="radio"||el.tagName.toLowerCase()==="select";
            const eventName=isChoice?"change":"input";
            el.dispatchEvent(new Event(eventName,{bubbles:true}));
          }
        }
      });
    }
  });
  observer.observe(document.body,{childList:true,subtree:true});
  refreshQuick();
  renderAll();
}
function clearFieldState(){
  FIELD_STATE={};
  localStorage.removeItem(FIELD_LS_KEY);
}

function renderAllUI(){
  renderSelectors();renderPrices();renderPack();renderRecipes();refreshQuick();renderAll();
}

document.getElementById("calcK").addEventListener("click",()=>{
  const c=num(document.getElementById("c").value);
  const v=num(document.getElementById("v").value);
  const cv=num(document.getElementById("cv").value);
  document.getElementById("katsayi").value=computeKatsayi(c,v,cv).toFixed(3);
  setPill("KatsayÄ± hesaplandÄ± (yaklaÅŸÄ±k)","warn");
  refreshQuick();renderAll();
});
["c","v","cv","katsayi","targetSmall","targetKg"].forEach(id=>document.getElementById(id).addEventListener("input",()=>{refreshQuick()}));
["adetSel","ayranSel","ekmekSel"].forEach(id=>document.getElementById(id).addEventListener("input",refreshQuick));
document.getElementById("saveBtn").addEventListener("click",save);
document.getElementById("loadBtn").addEventListener("click",load);
document.getElementById("resetBtn").addEventListener("click",()=>{
  if(confirm("TÃ¼m verileri sÄ±fÄ±rlayÄ±p varsayÄ±lana dÃ¶ndÃ¼reyim mi?")){
    localStorage.removeItem(LS_KEY);
    clearFieldState();
    resetAll();
  }
});
document.getElementById("refreshAll").addEventListener("click",()=>{renderAll(); setPill("Ã–zet yenilendi","ok");});
document.getElementById("addPackExtra").addEventListener("click",()=>{
  STATE.packExtras.push({item:"",qty:0});
  renderPack();refreshQuick();
  scheduleStateSave();
});

if(localStorage.getItem(LS_KEY)){
  load();
}else{
  pushParamsToUI();
  renderAllUI();
  setPill("Durum: hazÄ±r âœ…","ok");
}
initFieldPersistence();
</script>
  <a href="https://nusretsevuk-collab.github.io/maliyet-robotu/"
   target="_blank" rel="noopener noreferrer"
   style="
     position: fixed;
     top: 14px; right: 14px;
     padding: 10px 14px;
     border-radius: 12px;
     background: #2ea043;
     color: #fff;
     text-decoration: none;
     font-weight: 800;
     z-index: 999999;
     box-shadow: 0 10px 24px rgba(0,0,0,.35);
   ">
  ðŸ“ˆ GÃ¼nlÃ¼k SipariÅŸ Takip
</a>

</body>
</html>
